Overview
========

sv.sh is a tiny supervisor written in bash.


SYNOPSIS
========

echo SPEC | ./sv.sh TAG
./sv.sh -h|--help
./sv.sh -v|--version


DESCRIPTION
===========

sv.sh daemonize after start and run specified commands in SPEC.
If any child has terminated, then sv.sh run it again.

TAG is used to name a pid file and log files or as syslog tag (if a logging
to syslog is enabled). TAG shouldn't start with "-" (dash) and contains dot.

sv.sh can log to stdout/stderr, to files or to syslog. If SV_SYSLOG is not
empty, then sv.sh log to syslog. Otherwise, sv.sh log to files.

If sv.sh log to files, it creates separate files for sv stdout and stderr
and separate files for child stdout and stderr (4 files in total).
if sv.sh is got SIGHUP, it reopen it log and check a child log size. If a
child log is bigger than SV_PRG_LOGFILE_MAXSIZE bytes, then it stop a child
and run it again with a redirection to new log files. Thus, more often SIGHUP
is sent - better size control.

If sv.sh log to syslog, it logs its and child stdout/stderr to a specified
syslog priority. Logging to syslog is done via logger utility, which run in
the background.


SPEC
====

SPEC consist of command specs. Each command spec is a one line with the next
syntax:

ACT PRMS

Where:
 ACT
   Action. wait or run.
   wait - delay SPEC execution for a specified time(with units as a postfix;
          i.e. 2s, 10s, etc)
   run  - run a specified program
 PRMS
   action parameters.

 wait action parameters: TIME. TIME is a number with a time unit. I.e. 10s, 4s, etc.
 run action parameters: PRGTAG RS BIN [BIN_PRMS].
   PRGTAG is used for log messages. It shouldn't contains dot.
   RS is a restart strategy. one or all. one - if this program is terminated, then
   restart it. all - if this program is terminated, then restart all programs from
   SPEC.
   BIN is a binary to start.
   BIN_PRMS is a command line parameters for specified binary.


CONFIGURATION
=============

sv.sh has some parameters that can be changed with help of environment
variables.

SV_RESTART_DELAY
    The delay (with suffix s, m, etc) between child restarts.
    Default is 2s.
SV_LOGPATH
    The directory for log files.
	If a path isn't an absolute path, then it's converted to an absolute path
	by prepending "$PWD/" to it.
    If unset, then log to stdout/stderr.
    Default is "" (unset).
SV_PIDPATH
    The directory for pid file with our pid.
	If a path isn't an absolute path, then it's converted to an absolute path
	by prepending "$PWD/" to it.
    If unset, then do not create a pid file.
    Default is "" (unset).
SV_LOGFILES_CNT
    A maximum count of sv log files.
    Default is 30.
SV_PRG_LOGFILE_MAXSIZE
    Maximum size(in bytes) of child current log file for log reopening.
    Default is 10000000.
SV_PRG_LOGFILE_MAXCNT
    A maximum count of child log files.
    Default is 3.
SV_SYSLOG
    The value is a syslog priority (facility.level). See logger(1) for
    syntax (option -p).
    Default is "" (none).
SV_KILLSEQ
    A sequence of "SIGNAL/TIME_TO_WAIT" separated with / for child
    termination. There is no need to specify KILL, because SIGKILL is
    sent to child in any case if it isn't terminated after specified kill
    sequence.
    Default is "TERM/2s/TERM/4s".
SV_CHDIR
    Set to "no" to not change dir to / after startup.
    Default is "yes".


EXAMPLE
=======

A script to start some service can be like this:

#!/bin/bash
# Supervisor settings
export SV_PIDPATH=/var/run
export SV_SYSLOG=user.notice
echo "run prg1 one sleep 10s
run prg2 all sleep 35s" | ./sv.sh env1
